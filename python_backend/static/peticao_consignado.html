<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jul.IA | Peti√ß√£o Inicial Empr√©stimo Consignado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#121212; --card:#1E1E1E; --border:#2D2D2D;
      --text:#EAEAEA; --muted:#AAAAAA;
      --primary:#0D99FF; --primary-hover:#0B7ACC; --accent:#4DB8FF;
      --radius:16px; --pad:18px; --gap:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:24px;border-bottom:1px solid var(--border);padding-bottom:16px}
    .brand{font-weight:700;letter-spacing:.2px;font-size:18px}
    .brand span{color:var(--accent);font-weight:600}
    .subtitle{color:var(--accent);font-weight:600;text-align:right}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:0 0 0 1px rgba(0,0,0,.12), 0 6px 18px rgba(0,0,0,.25)}
    .card h2{margin:0 0 14px 0;font-size:18px;font-weight:600}
    .card h3{margin:10px 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:500}
    input,select,textarea{width:100%;background:#161616;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:11px;font-size:13px;outline:none;font-family:inherit}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(13,153,255,.1)}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:700px){.row{grid-template-columns:repeat(2,1fr)}}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn{appearance:none;border:none;cursor:pointer;background:var(--primary);color:#fff;padding:11px 16px;border-radius:10px;font-weight:600;font-size:13px;transition:.2s}
    .btn:hover{background:var(--primary-hover);transform:translateY(-1px)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.ghost:hover{background:rgba(13,153,255,.05);border-color:var(--primary)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{display:inline-block;background:#0e2233;color:#9ed0ff;border:1px solid #204a6b;padding:5px 10px;border-radius:999px;font-size:11px;font-weight:600}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:12px;vertical-align:middle}
    th{color:var(--muted);letter-spacing:.3px;font-weight:600;background:#161616}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .toggle{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:44px;height:26px;background:#2a2a2a;border-radius:999px;border:1px solid var(--border);flex:0 0 auto}
    .switch input{display:none}
    .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;background:#777;border-radius:50%;transition:.2s ease}
    .switch input:checked + .knob{left:22px;background:var(--primary)}
    footer{margin:32px 0 12px;color:var(--muted);text-align:center;font-size:11px;border-top:1px solid var(--border);padding-top:16px}
    .preview{white-space:pre-wrap;background:#161616;border:1px dashed var(--border);padding:12px;border-radius:10px;color:#d7efff;font-size:12px;min-height:60px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .onecol{grid-column:1 / -1}
    .mm, .aa { width:60px; text-align:center }
    .slash { padding:0 4px; display:inline-block; color:var(--muted) }
    .info-box{background:rgba(13,153,255,.05);border:1px solid rgba(13,153,255,.2);border-radius:10px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--text)}
    .error-box{background:rgba(255,100,100,.05);border:1px solid rgba(255,100,100,.2);border-radius:10px;padding:12px;margin-bottom:12px;font-size:12px;color:#ff6464}
    .success-box{background:rgba(100,255,100,.05);border:1px solid rgba(100,255,100,.2);border-radius:10px;padding:12px;margin-bottom:12px;font-size:12px;color:#64ff64}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #links{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    #links a{display:inline-flex;align-items:center;gap:6px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Jul.IA <span>| Plataforma Inteligente de Peti√ß√µes</span></div>
      <div class="subtitle">Peti√ß√£o Inicial Empr√©stimo Consignado</div>
    </header>

    <div class="grid">
      <!-- Q1: Endere√ßamento (NOVO, com lista de estados + cidades sugeridas) -->
      <section class="card onecol" id="q1-enderecamento">
        <h2>1) Endere√ßamento da pe√ßa</h2>
        <div class="row">
          <div>
            <label>Estado (sele√ß√£o ‚ÄúDO / DE / DA‚Äù)</label>
            <select id="estadoSelect">
              <option value="">Selecione o Estado</option>
              <!-- op√ß√µes preenchidas via JS -->
            </select>
          </div>
          <div>
            <label>Cidade (sugest√µes principais do Estado)</label>
            <select id="cidadeSugestoes" disabled>
              <option value="">Selecione um estado primeiro</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label>Cidade (digite manualmente, se quiser outra)</label>
            <input id="cidadeManual" placeholder="Digite a cidade" oninput="this.value = this.value.toUpperCase()" />
          </div>
          <div>
            <label>Tipo de √ìrg√£o (mai√∫sculas)</label>
            <div class="actions">
              <button type="button" class="btn ghost" data-orgao="DA VARA C√çVEL">DA VARA C√çVEL</button>
              <button type="button" class="btn ghost" data-orgao="DO JUIZADO ESPECIAL C√çVEL">DO JUIZADO ESPECIAL C√çVEL</button>
              <button type="button" class="btn ghost" data-orgao="DA VARA C√çVEL FEDERAL">DA VARA C√çVEL FEDERAL</button>
              <button type="button" class="btn ghost" data-orgao="DO JUIZADO ESPECIAL C√çVEL FEDERAL">DO JUIZADO ESPECIAL C√çVEL FEDERAL</button>
            </div>
            <input id="tipoOrgao" class="mono" readonly placeholder="Selecione acima" style="margin-top:8px" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label>Pr√©via (formata√ß√£o da pe√ßa)</label>
            <div class="preview" id="prevEnd"></div>
          </div>
          <div>
            <label>Cabe√ßalho final no DOCX</label>
            <div class="preview">
EXCELENT√çSSIMO/A SENHOR/A DOUTOR/A
JUIZ/A DE DIREITO {{TIPO_ORGAO}} DA COMARCA DE {{CIDADE}} ‚Äì ESTADO {{ESTADO_EXTENSO}}
            </div>
          </div>
        </div>
      </section>

      <!-- Q2: Dados da Parte Autora (INALTERADO) -->
      <section class="card onecol" id="q2-autora">
        <h2>2) Dados da Parte Autora</h2>
        <div class="info-box">Cole o TXT exatamente no formato do formul√°rio fornecido (https://formulario.julianogarbuggio.adv.br/)</div>
        <textarea id="txtAutora" class="mono" placeholder="Nome completo: &#10;Nacionalidade: &#10;Data de nascimento: &#10;Estado civil: &#10;Profiss√£o: &#10;RG:  - ESTADO: &#10;CPF: &#10;ENDERE√áO COMPLETO: , n¬∫: , complemento:  &#10;Bairro: &#10;CEP: &#10;CIDADE: , ESTADO: &#10;WhatsApp COM DDD: &#10;E-mail: "></textarea>
        <div class="actions">
          <button class="btn" id="btnParse">Extrair dados</button>
        </div>
        <h3>Pr√©-visualiza√ß√£o no molde do DOCX</h3>
        <div class="preview" id="prevAutora"></div>
      </section>

      <!-- Q3: Dados da Parte R√© (INALTERADO) -->
      <section class="card onecol" id="q3-re">
        <h2>3) Dados da Parte R√©</h2>
        <div class="row">
          <div>
            <label>CNPJ</label>
            <input id="cnpj" placeholder="00.000.000/0001-00" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <label class="toggle">
                <div class="switch"><input type="checkbox" id="lookupOn" checked><span class="knob"></span></div>
                <span style="font-size:12px">Usar busca online</span>
              </label>
              <button type="button" class="btn" id="btnBuscarCNPJ">Buscar</button>
              <button type="button" class="btn ghost" id="btnEditarRe">Editar</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label>Raz√£o Social</label>
            <input id="NOME_EMPRESA" />
          </div>
          <div>
            <label>Logradouro</label>
            <input id="LOG_RE" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>N√∫mero</label>
            <input id="N_RE" />
          </div>
          <div>
            <label>Complemento</label>
            <input id="COMPL_RE" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Bairro</label>
            <input id="BAIRRO_RE" />
          </div>
          <div>
            <label>Cidade / UF</label>
            <div class="row">
              <input id="CIDADE_RE" placeholder="Cidade" />
              <input id="UF_RE" placeholder="UF" maxlength="2" />
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>CEP</label>
            <input id="CEP_RE" />
          </div>
          <div>
            <label>Resumo</label>
            <div id="prevRe" class="preview"></div>
          </div>
        </div>
      </section>

      <!-- Q4: Tabela de Contratos (INALTERADO) -->
      <section class="card onecol" id="q4-contratos">
        <h2>4) Tabela dos Contratos Revisados (II.1)</h2>
        <div class="actions">
          <button class="btn" id="btnAddLinha">+ Adicionar linha</button>
          <button class="btn ghost" id="btnLimparLinhas">Limpar</button>
          <span class="badge" id="badgeAtivo">HAS_ATIVO: false</span>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table id="tabContratos">
            <thead>
              <tr>
                <th>N¬∫ Contrato</th>
                <th>In√≠cio (MM/AA)</th>
                <th>Fim (MM/AA)</th>
                <th>Situa√ß√£o</th>
                <th>Parcela R$</th>
                <th>Pago</th>
                <th>A Pagar</th>
                <th>C√≥pia</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <!-- Linhas de contrato ser√£o inseridas aqui -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="right"><strong>TOTAL PAGO:</strong></td>
                <td id="totalPago">R$ 0,00</td>
                <td colspan="3"></td>
              </tr>
              <tr>
                <td colspan="5" class="right"><strong>TOTAL EM DOBRO:</strong></td>
                <td id="totalDobro">R$ 0,00</td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- Q5: Nome da A√ß√£o (INALTERADO) -->
      <section class="card onecol" id="q5-acao">
        <h2>5) Nome da A√ß√£o (Din√¢mico)</h2>
        <div id="nomeAcao" class="preview">A√á√ÉO DECLARAT√ìRIA DE NULIDADE CONTRATUAL C/C REPETI√á√ÉO DE IND√âBITO E DANOS MORAIS</div>
        <h3>Op√ß√µes Adicionais</h3>
        <label class="toggle">
          <div class="switch"><input type="checkbox" id="forcarTutela"><span class="knob"></span></div>
          <span>For√ßar marca√ß√£o de TUTELA ANTECIPADA</span>
        </label>
      </section>

      <!-- Q6: Gerar Documento (INALTERADO) -->
      <section class="card onecol" id="q6-gerar">
        <h2>6) Gerar Documento</h2>
        <div class="info-box">Selecione o(s) formato(s) desejado(s) para gerar a peti√ß√£o preenchida</div>
        <div class="actions">
          <button class="btn" id="btnGerarDocx">üìÑ Gerar DOCX</button>
          <button class="btn" id="btnGerarPdf">üìã Gerar PDF</button>
          <button class="btn" id="btnGerarAmbos">üì¶ Gerar DOCX + PDF</button>
        </div>
        <div id="links" style="margin-top:12px"></div>
      </section>
    </div>

    <footer>
      ¬© 2025 Juliano Garbuggio - Advocacia & Consultoria | Powered by Jul.IA - Intelig√™ncia Jur√≠dica Automatizada
    </footer>
  </div>

  <script>
    // -----------------------------
    // LISTAS DE ESTADOS E CIDADES
    // -----------------------------
    const ESTADOS_CABECALHO = [
      { uf: "AC", label: "DO ACRE" },
      { uf: "AL", label: "DE ALAGOAS" },
      { uf: "AP", label: "DO AMAP√Å" },
      { uf: "AM", label: "DO AMAZONAS" },
      { uf: "BA", label: "DA BAHIA" },
      { uf: "CE", label: "DO CEAR√Å" },
      { uf: "DF", label: "DO DISTRITO FEDERAL" },
      { uf: "ES", label: "DO ESP√çRITO SANTO" },
      { uf: "GO", label: "DE GOI√ÅS" },
      { uf: "MA", label: "DO MARANH√ÉO" },
      { uf: "MT", label: "DE MATO GROSSO" },
      { uf: "MS", label: "DE MATO GROSSO DO SUL" },
      { uf: "MG", label: "DE MINAS GERAIS" },
      { uf: "PA", label: "DO PAR√Å" },
      { uf: "PB", label: "DA PARA√çBA" },
      { uf: "PR", label: "DO PARAN√Å" },
      { uf: "PE", label: "DE PERNAMBUCO" },
      { uf: "PI", label: "DO PIAU√ç" },
      { uf: "RJ", label: "DO RIO DE JANEIRO" },
      { uf: "RN", label: "DO RIO GRANDE DO NORTE" },
      { uf: "RS", label: "DO RIO GRANDE DO SUL" },
      { uf: "RO", label: "DE ROND√îNIA" },
      { uf: "RR", label: "DE RORAIMA" },
      { uf: "SC", label: "DE SANTA CATARINA" },
      { uf: "SP", label: "DE S√ÉO PAULO" },
      { uf: "SE", label: "DE SERGIPE" },
      { uf: "TO", label: "DO TOCANTINS" }
    ];

    const CIDADES_POR_ESTADO = {
      "AC": ["RIO BRANCO", "CRUZEIRO DO SUL", "TARAUAC√Å", "SENA MADUREIRA"],
      "AL": ["MACEI√ì", "ARAPIRACA", "RIO LARGO", "PALMEIRA DOS √çNDIOS"],
      "AP": ["MACAP√Å", "SANTANA", "LARANJAL DO JARI", "OIAPOQUE"],
      "AM": ["MANAUS", "ITACOATIARA", "MANACAPURU", "PARINTINS"],
      "BA": ["SALVADOR", "FEIRA DE SANTANA", "VIT√ìRIA DA CONQUISTA", "CAMA√áARI"],
      "CE": ["FORTALEZA", "CAUCAIA", "JUAZEIRO DO NORTE", "MARACANA√ö"],
      "DF": ["CEIL√ÇNDIA", "SAMAMBAIA", "PLANO PILOTO", "TAGUATINGA"],
      "ES": ["SERRA", "VILA VELHA", "CARIACICA", "VIT√ìRIA"],
      "GO": ["GOI√ÇNIA", "APARECIDA DE GOI√ÇNIA", "AN√ÅPOLIS", "RIO VERDE"],
      "MA": ["S√ÉO LU√çS", "IMPERATRIZ", "S√ÉO JOS√â DE RIBAMAR", "TIMON"],
      "MT": ["CUIAB√Å", "V√ÅRZEA GRANDE", "RONDON√ìPOLIS", "SINOP"],
      "MS": ["CAMPO GRANDE", "DOURADOS", "TR√äS LAGOAS", "CORUMB√Å"],
      "MG": ["BELO HORIZONTE", "UBERL√ÇNDIA", "CONTAGEM", "JUIZ DE FORA"],
      "PA": ["BEL√âM", "ANANINDEUA", "SANTAR√âM", "PARAUAPEBAS"],
      "PB": ["JO√ÉO PESSOA", "CAMPINA GRANDE", "SANTA RITA", "PATOS"],
      "PR": ["CURITIBA", "LONDRINA", "MARING√Å", "PONTA GROSSA"],
      "PE": ["RECIFE", "JABOAT√ÉO DOS GUARARAPES", "PETROLINA", "CARUARU"],
      "PI": ["TERESINA", "PARNA√çBA", "PICOS", "PIRIPIRI"],
      "RJ": ["RIO DE JANEIRO", "S√ÉO GON√áALO", "DUQUE DE CAXIAS", "NOVA IGUA√áU"],
      "RN": ["NATAL", "MOSSOR√ì", "PARNAMIRIM", "S√ÉO GON√áALO DO AMARANTE"],
      "RS": ["PORTO ALEGRE", "CAXIAS DO SUL", "CANOAS", "PELOTAS"],
      "RO": ["PORTO VELHO", "JI-PARAN√Å", "ARIQUEMES", "VILHENA"],
      "RR": ["BOA VISTA", "RORAIN√ìPOLIS", "ALTO ALEGRE", "CARACARA√ç"],
      "SC": ["JOINVILLE", "FLORIAN√ìPOLIS", "BLUMENAU", "S√ÉO JOS√â"],
      "SP": ["S√ÉO PAULO", "GUARULHOS", "CAMPINAS", "S√ÉO BERNARDO DO CAMPO"],
      "SE": ["ARACAJU", "NOSSA SENHORA DO SOCORRO", "ITABAIANA", "LAGARTO"],
      "TO": ["PALMAS", "ARAGUA√çNA", "GURUPI", "PORTO NACIONAL"]
    };

    function getEstadoByUF(uf) {
      return ESTADOS_CABECALHO.find(e => e.uf === uf.toUpperCase()) || null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // --------- BLOCO 1: ENDERE√áAMENTO NOVO ----------
      const estadoSelect = document.getElementById('estadoSelect');
      const cidadeSugestoes = document.getElementById('cidadeSugestoes');
      const cidadeManualInput = document.getElementById('cidadeManual');
      const tipoOrgaoInput = document.getElementById('tipoOrgao');
      const prevEnd = document.getElementById('prevEnd');
      const tabContratosBody = document.querySelector('#tabContratos tbody');

      // Preenche estados
      ESTADOS_CABECALHO.forEach(est => {
        const opt = document.createElement('option');
        opt.value = est.uf;
        opt.textContent = `${est.uf} ‚Äì ${est.label}`;
        estadoSelect.appendChild(opt);
      });

      function updateCidadeSugestoes() {
        const uf = estadoSelect.value.toUpperCase();
        cidadeSugestoes.innerHTML = '';
        if (!uf) {
          cidadeSugestoes.disabled = true;
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Selecione um estado primeiro';
          cidadeSugestoes.appendChild(opt);
          return;
        }
        const cidades = CIDADES_POR_ESTADO[uf] || [];
        const primeira = document.createElement('option');
        primeira.value = '';
        primeira.textContent = 'Escolha uma cidade sugerida (opcional)';
        cidadeSugestoes.appendChild(primeira);

        cidades.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          cidadeSugestoes.appendChild(opt);
        });

        const outra = document.createElement('option');
        outra.value = '__OUTRA__';
        outra.textContent = 'OUTRA (DIGITAR MANUALMENTE)';
        cidadeSugestoes.appendChild(outra);

        cidadeSugestoes.disabled = false;
      }

      function updatePrevEnd() {
        const uf = estadoSelect.value.toUpperCase();
        const est = getEstadoByUF(uf);
        const estadoExtenso = est ? est.label : '';
        const cidade = (cidadeManualInput.value || '').toUpperCase();
        const tipoOrgao = (tipoOrgaoInput.value || '').toUpperCase();

        let linha1 = 'EXCELENT√çSSIMO/A SENHOR/A DOUTOR/A';
        let linha2 = 'JUIZ/A DE DIREITO';
        if (tipoOrgao) linha2 += ' ' + tipoOrgao;
        linha2 += cidade ? ` DA COMARCA DE ${cidade}` : ' DA COMARCA DE ________';
        if (estadoExtenso) linha2 += ` ‚Äì ESTADO ${estadoExtenso}`;

        prevEnd.textContent = linha1 + '\n' + linha2;
      }

      estadoSelect.addEventListener('change', () => {
        updateCidadeSugestoes();
        updatePrevEnd();
      });

      cidadeSugestoes.addEventListener('change', () => {
        const val = cidadeSugestoes.value;
        if (val && val !== '__OUTRA__') {
          cidadeManualInput.value = val.toUpperCase();
        } else if (val === '__OUTRA__') {
          cidadeManualInput.focus();
        }
        updatePrevEnd();
      });

      cidadeManualInput.addEventListener('input', () => {
        cidadeManualInput.value = cidadeManualInput.value.toUpperCase();
        updatePrevEnd();
      });

      document.querySelectorAll('[data-orgao]').forEach(btn => {
        btn.addEventListener('click', () => {
          tipoOrgaoInput.value = btn.dataset.orgao;
          updatePrevEnd();
        });
      });

      // ------------- A PARTIR DAQUI: SEU JS ORIGINAL (Q2‚ÄìQ6) -------------
      // Parse do TXT da parte autora
      const btnParse = document.getElementById('btnParse');
      btnParse.addEventListener('click', () => {
        const txt = document.getElementById('txtAutora').value;
        const data = parseTxtAutora(txt);
        const preview = `NOME: ${data.NOME_COMPLETO}\nCPF: ${data.CPF}\nENDERE√áO: ${data.LOGRADOURO}, ${data.NUMERO} - ${data.BAIRRO}, ${data.CIDADE_AUTOR}/${data.ESTADO_AUTOR}`;
        document.getElementById('prevAutora').textContent = preview;
      });

      function parseTxtAutora(txt) {
        const lines = txt.split('\n');
        const data = {};
        lines.forEach(line => {
          const [key, ...value] = line.split(':');
          const val = value.join(':').trim();
          if (key.includes('Nome completo')) data.NOME_COMPLETO = val;
          if (key.includes('Nacionalidade')) data.NACIONALIDADE = val;
          if (key.includes('Data de nascimento')) data.NASCIMENTO = val;
          if (key.includes('Estado civil')) data.ESTADO_CIVIL = val;
          if (key.includes('Profiss√£o')) data.PROFISSAO = val;
          if (key.includes('RG')) {
            const rgParts = val.split('-');
            data.RG = rgParts[0]?.trim();
            data.ESTADO_RG = rgParts[1]?.replace('ESTADO', '').trim();
          }
          if (key.includes('CPF')) data.CPF = val;
          if (key.includes('ENDERE√áO COMPLETO')) {
            const endParts = val.split(',');
            data.LOGRADOURO = endParts[0]?.trim();
            data.NUMERO = endParts[1]?.replace('n¬∫', '').trim();
            data.COMPLEMENTO = endParts[2]?.replace('complemento', '').trim();
          }
          if (key.includes('Bairro')) data.BAIRRO = val;
          if (key.includes('CEP')) data.CEP = val;
          if (key.includes('CIDADE')) {
            const cidParts = val.split(',');
            data.CIDADE_AUTOR = cidParts[0]?.trim();
            data.ESTADO_AUTOR = cidParts[1]?.replace('ESTADO', '').trim();
          }
          if (key.includes('WhatsApp')) data.WHATSAPP = val;
          if (key.includes('E-mail')) data.EMAIL = val;
        });
        return data;
      }

      // CNPJ Lookup
      const btnBuscarCNPJ = document.getElementById('btnBuscarCNPJ');
      btnBuscarCNPJ.addEventListener('click', async () => {
        const cnpj = document.getElementById('cnpj').value.replace(/[^\d]/g, '');
        if (cnpj.length !== 14) {
          alert('CNPJ inv√°lido.');
          return;
        }

        if (!document.getElementById('lookupOn').checked) {
          updatePrevRe();
          return;
        }

        btnBuscarCNPJ.innerHTML = '<span class="spinner"></span> Buscando...';
        btnBuscarCNPJ.disabled = true;

        // Tenta 4 APIs em sequ√™ncia (fallback)
        const tries = [
          `/api/cnpj/brasilapi/${cnpj}`,
          `/api/cnpj/receitaws/${cnpj}`,
          `https://brasilapi.com.br/api/cnpj/v1/${cnpj}`,
          `https://www.receitaws.com.br/v1/cnpj/${cnpj}`
        ];

        let success = false;
        for (const url of tries) {
          try {
            const response = await fetch(url, {
              mode: url.startsWith('http') ? 'cors' : 'same-origin'
            });
            if (response.ok) {
              const data = await response.json();
              
              document.getElementById('NOME_EMPRESA').value = data.nome || data.razao_social || data.nome_fantasia || '';
              document.getElementById('LOG_RE').value = data.logradouro || data.street || '';
              document.getElementById('N_RE').value = data.numero || data.number || '';
              document.getElementById('COMPL_RE').value = data.complemento || data.complement || '';
              document.getElementById('BAIRRO_RE').value = data.bairro || data.neighborhood || '';
              document.getElementById('CIDADE_RE').value = data.municipio || data.city || '';
              document.getElementById('UF_RE').value = (data.uf || data.state || '').toUpperCase();
              document.getElementById('CEP_RE').value = data.cep || data.postal_code || '';

              updatePrevRe();
              success = true;
              break;
            }
          } catch (e) {
            // Continua para pr√≥xima API
          }
        }

        if (!success) {
          alert('N√£o foi poss√≠vel obter dados online. Preencha manualmente.');
        }

        btnBuscarCNPJ.innerHTML = 'Buscar';
        btnBuscarCNPJ.disabled = false;
      });

      const reInputs = ['NOME_EMPRESA', 'LOG_RE', 'N_RE', 'COMPL_RE', 'BAIRRO_RE', 'CIDADE_RE', 'UF_RE', 'CEP_RE'];
      reInputs.forEach(id => document.getElementById(id).addEventListener('input', updatePrevRe));

      function updatePrevRe() {
        const data = {};
        reInputs.forEach(id => data[id] = document.getElementById(id).value);
        document.getElementById('prevRe').textContent = `${data.NOME_EMPRESA}, CNPJ ${document.getElementById('cnpj').value}, ${data.LOG_RE}, n¬∫ ${data.N_RE}, ${data.COMPL_RE}, ${data.BAIRRO_RE}, ${data.CIDADE_RE}/${data.UF_RE}, CEP ${data.CEP_RE}`;
      }

      document.getElementById('btnEditarRe').addEventListener('click', () => {
        reInputs.forEach(id => document.getElementById(id).readOnly = !document.getElementById(id).readOnly);
      });

      // Tabela de Contratos (igual)
      const btnAddLinha = document.getElementById('btnAddLinha');

      btnAddLinha.addEventListener('click', () => {
        const rowCount = tabContratosBody.rows.length + 1;
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td><input class="mono" placeholder="Ex: 123456" id="CT${rowCount}_NUMERO" /></td>
          <td>
            <input class="mm" placeholder="MM" id="CT${rowCount}_INICIO_MM" />
            <span class="slash">/</span>
            <input class="aa" placeholder="AA" id="CT${rowCount}_INICIO_AA" />
          </td>
          <td>
            <input class="mm" placeholder="MM" id="CT${rowCount}_FIM_MM" />
            <span class="slash">/</span>
            <input class="aa" placeholder="AA" id="CT${rowCount}_FIM_AA" />
          </td>
          <td>
            <select id="CT${rowCount}_SITUACAO">
              <option>ENCERRADO</option>
              <option>ATIVO</option>
            </select>
          </td>
          <td><input class="parcela-input" placeholder="0,00" id="CT${rowCount}_PARCELA" /></td>
          <td class="pago-cell">R$ 0,00</td>
          <td class="apagar-cell">R$ 0,00</td>
          <td>
            <select id="CT${rowCount}_COPIA">
              <option>SIM</option>
              <option>N√ÉO</option>
            </select>
          </td>
          <td><button type="button" class="btn ghost btn-remove">‚úï</button></td>
        `;
        tabContratosBody.appendChild(newRow);
        newRow.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateContratos));
        newRow.querySelector('.btn-remove').addEventListener('click', () => {
          newRow.remove();
          updateContratos();
        });
      });

      document.getElementById('btnLimparLinhas').addEventListener('click', () => {
        tabContratosBody.innerHTML = '';
        updateContratos();
      });

      function updateContratos() {
        let totalPago = 0;
        let totalDobro = 0;
        let hasAtivo = false;

        tabContratosBody.querySelectorAll('tr').forEach(row => {
          const inicioMM = row.querySelector('[id*="_INICIO_MM"]').value;
          const inicioAA = row.querySelector('[id*="_INICIO_AA"]').value;
          const fimMM = row.querySelector('[id*="_FIM_MM"]').value;
          const fimAA = row.querySelector('[id*="_FIM_AA"]').value;
          const situacao = row.querySelector('[id*="_SITUACAO"]').value;
          const parcelaInput = row.querySelector('.parcela-input');

          let parcelaString = parcelaInput.value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
          const parcelaFloat = parseFloat(parcelaString);

          if (!isNaN(parcelaFloat) && inicioMM && inicioAA && fimMM && fimAA) {
            const inicio = new Date(parseInt(`20${inicioAA}`), parseInt(inicioMM) - 1, 1);
            const fim = new Date(parseInt(`20${fimAA}`), parseInt(fimMM) - 1, 1);
            const hoje = new Date();
            
            const mesesContrato = (fim.getFullYear() - inicio.getFullYear()) * 12 + (fim.getMonth() - inicio.getMonth()) + 1;
            const mesesAteHoje = (hoje.getFullYear() - inicio.getFullYear()) * 12 + (hoje.getMonth() - inicio.getMonth()) + 1;
            const mesesPagos = Math.max(0, Math.min(mesesContrato, mesesAteHoje));
            const mesesRestantes = Math.max(0, mesesContrato - mesesPagos);

            const pago = parcelaFloat * mesesPagos;
            const aPagar = (situacao === 'ATIVO' && mesesRestantes > 0) ? parcelaFloat * mesesRestantes : 0;

            row.querySelector('.pago-cell').textContent = pago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            row.querySelector('.apagar-cell').textContent = aPagar.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            totalPago += pago;
            row.dataset.pagoFloat = pago;
            row.dataset.apagarFloat = aPagar;
          }

          if (situacao === 'ATIVO') hasAtivo = true;
        });

        totalDobro = totalPago * 2;
        document.getElementById('totalPago').textContent = totalPago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.getElementById('totalDobro').textContent = totalDobro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        const badgeAtivo = document.getElementById('badgeAtivo');
        badgeAtivo.textContent = `HAS_ATIVO: ${hasAtivo}`;
        if (hasAtivo) {
          badgeAtivo.style.background = '#330e0e';
          badgeAtivo.style.color = '#ff9e9e';
          badgeAtivo.style.borderColor = '#6b2020';
        } else {
          badgeAtivo.style.background = '#0e2233';
          badgeAtivo.style.color = '#9ed0ff';
          badgeAtivo.style.borderColor = '#204a6b';
        }

        updateNomeAcao(hasAtivo);
      }

      function updateNomeAcao(hasAtivo) {
        const forcarTutela = document.getElementById('forcarTutela').checked;
        const nomeAcaoDiv = document.getElementById('nomeAcao');
        let nomeAcao = 'A√á√ÉO DECLARAT√ìRIA DE NULIDADE CONTRATUAL C/C REPETI√á√ÉO DE IND√âBITO E DANOS MORAIS';
        if (hasAtivo || forcarTutela) {
          nomeAcao += ' COM PEDIDO DE TUTELA ANTECIPADA';
        }
        nomeAcaoDiv.textContent = nomeAcao;
      }

      document.getElementById('forcarTutela').addEventListener('change', () => updateContratos());

      // Gera√ß√£o de Documentos (AJUSTADO S√ì PRA USAR ESTADO_EXTENSO)
      document.getElementById('btnGerarDocx').addEventListener('click', () => generateDocument('docx'));
      document.getElementById('btnGerarPdf').addEventListener('click', () => generateDocument('pdf'));
      document.getElementById('btnGerarAmbos').addEventListener('click', () => generateDocument('both'));

      async function generateDocument(format) {
        const btnId = format === 'both' ? 'btnGerarAmbos' : `btnGerar${format.charAt(0).toUpperCase() + format.slice(1)}`;
        const btn = document.getElementById(btnId);
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span> Gerando...';
        btn.disabled = true;

        // 1. Endere√ßamento (NOVO)
        const uf = (estadoSelect.value || '').toUpperCase();
        const estObj = getEstadoByUF(uf) || { uf: uf, label: '' };
        const estadoExtenso = estObj.label || '';
        const cidade = (cidadeManualInput.value || '').toUpperCase();
        const tipoOrgao = tipoOrgaoInput.value;

        // 2. Dados da Parte Autora
        const txtAutora = document.getElementById('txtAutora').value;
        let dadosAutora = parseTxtAutora(txtAutora);

        // 3. Dados da Parte R√©
        const cnpj = document.getElementById('cnpj').value;
        const nomeEmpresa = document.getElementById('NOME_EMPRESA').value;
        const logRe = document.getElementById('LOG_RE').value;
        const nRe = document.getElementById('N_RE').value;
        const complRe = document.getElementById('COMPL_RE').value;
        const bairroRe = document.getElementById('BAIRRO_RE').value;
        const cidadeRe = document.getElementById('CIDADE_RE').value;
        const ufRe = document.getElementById('UF_RE').value;
        const cepRe = document.getElementById('CEP_RE').value;

        // 4. Tabela de Contratos
        const contratos = [];
        tabContratosBody.querySelectorAll('tr').forEach((row, index) => {
          const i = index + 1;
          const numeroContrato = row.querySelector(`[id*="CT${i}_NUMERO"]`).value;
          const inicioMM = row.querySelector(`[id*="CT${i}_INICIO_MM"]`).value;
          const inicioAA = row.querySelector(`[id*="CT${i}_INICIO_AA"]`).value;
          const fimMM = row.querySelector(`[id*="CT${i}_FIM_MM"]`).value;
          const fimAA = row.querySelector(`[id*="CT${i}_FIM_AA"]`).value;
          const situacao = row.querySelector(`[id*="CT${i}_SITUACAO"]`).value;
          const parcela = row.querySelector('.parcela-input').value;
          const pago = row.querySelector('.pago-cell').textContent;
          const aPagar = row.querySelector('.apagar-cell').textContent;
          const copia = row.querySelector(`[id*="CT${i}_COPIA"]`).value;
          
          contratos.push({
            // Formato para tabela din√¢mica
            numero: numeroContrato,
            inicio: `${inicioMM}/${inicioAA}`,
            fim: `${fimMM}/${fimAA}`,
            situacao: situacao,
            parcela: parcela,
            pago: pago,
            a_pagar: aPagar,
            copia: copia,
            // Formato antigo para placeholders CT1_, CT2_, etc.
            [`CT${i}_NUMERO`]: numeroContrato,
            [`CT${i}_INICIO_MM`]: inicioMM,
            [`CT${i}_INICIO_AA`]: inicioAA,
            [`CT${i}_FIM_MM`]: fimMM,
            [`CT${i}_FIM_AA`]: fimAA,
            [`CT${i}_SITUACAO`]: situacao,
            [`CT${i}_PARCELA`]: parcela,
            [`CT${i}_PAGO`]: pago,
            [`CT${i}_APAGAR`]: aPagar,
            [`CT${i}_COPIA`]: copia,
            pagoFloat: parseFloat(row.dataset.pagoFloat),
            apagarFloat: parseFloat(row.dataset.apagarFloat),
          });
        });

        const totalPago = document.getElementById('totalPago').textContent;
        const totalDobro = document.getElementById('totalDobro').textContent;
        
        const totalDobroFloat = parseFloat(totalDobro.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
        const valorCausa = totalDobroFloat + 15000.00;
        const valorCausaFormatado = valorCausa.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // 5. Nome da A√ß√£o
        let hasAtivo = false;
        tabContratosBody.querySelectorAll('tr').forEach(row => {
          const situacao = row.querySelector('[id*="_SITUACAO"]').value;
          if (situacao === 'ATIVO') hasAtivo = true;
        });
        const forcarTutela = document.getElementById('forcarTutela').checked;

        // Data
        const hoje = new Date();
        const dia = String(hoje.getDate()).padStart(2, '0');
        const mesExtenso = hoje.toLocaleString('pt-BR', { month: 'long' });
        const ano = hoje.getFullYear();

        let context = {
          TIPO_ORGAO: tipoOrgao,
          CIDADE: cidade,
          ESTADO: uf,
          ESTADO_EXTENSO: estadoExtenso,
          ...dadosAutora,
          NOME_EMPRESA: nomeEmpresa,
          CNPJ: cnpj,
          LOG_RE: logRe,
          N_RE: nRe,
          COMPL_RE: complRe,
          BAIRRO_RE: bairroRe,
          CIDADE_RE: cidadeRe,
          UF_RE: ufRe,
          CEP_RE: cepRe,
          VALOR_PAGO_INDEVIDO: totalPago,
          VALOR_INDEVIDO_DOBRO: totalDobro,
          VALOR_CAUSA: valorCausaFormatado, 
          HAS_ATIVO: hasAtivo,
          MOSTRAR_TUTELA: forcarTutela,
          DIA: dia,
          MES_EXTENSO: mesExtenso,
          ANO: ano,
          VALOR_PAGO_INDEVIDO_FLOAT: parseFloat(totalPago.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()),
          VALOR_INDEVIDO_DOBRO_FLOAT: totalDobroFloat,
          VALOR_CAUSA_FLOAT: valorCausa,
          CONTRATOS: contratos, // Array de contratos para o template
        };

        contratos.forEach(ct => {
          Object.assign(context, ct);
          context[`CT${ct.numero}_PAGO_FLOAT`] = ct.pagoFloat;
          context[`CT${ct.numero}_APAGAR_FLOAT`] = ct.apagarFloat;
        });
        
        const cleanedContext = {};
        for (const key in context) {
          if (context[key] !== null && context[key] !== undefined) {
            cleanedContext[key] = context[key];
          }
        }
        context = cleanedContext;

        try {
          const respFormatos = format === 'both' ? ['docx', 'pdf'] : [format];
          const linksDiv = document.getElementById('links');
          linksDiv.innerHTML = '';

          for (const fmt of respFormatos) {
            const response = await fetch(`/api/generate/${fmt}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ context }),
            });

            if (!response.ok) throw new Error('Falha ao gerar documento');

            const result = await response.json();
            if (result.docx_url) {
              const a = document.createElement('a');
              a.href = result.docx_url;
              a.textContent = 'üìÑ Baixar DOCX';
              a.target = '_blank';
              a.className = 'btn';
              linksDiv.appendChild(a);
            }
            if (result.pdf_url) {
              const a = document.createElement('a');
              a.href = result.pdf_url;
              a.textContent = 'üìã Baixar PDF';
              a.target = '_blank';
              a.className = 'btn';
              linksDiv.appendChild(a);
            }
          }
        } catch (error) {
          alert('Erro ao gerar documento. Verifique o console para mais detalhes.');
          console.error(error);
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      // inicializa preview do endere√ßamento
      updateCidadeSugestoes();
      updatePrevEnd();
    });
  </script>
</body>
</html>
